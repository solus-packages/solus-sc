From d65d6251a7d123cd6588e4b01e7ac50ca62b3a8d Mon Sep 17 00:00:00 2001
From: Ikey Doherty <ikey@solus-project.com>
Date: Sun, 28 May 2017 23:13:05 +0100
Subject: [PATCH 3/4] changelog: Simplify bug/cve match to not be greedy

Signed-off-by: Ikey Doherty <ikey@solus-project.com>
---
 solus_sc/changelog.py | 20 ++++----------------
 1 file changed, 4 insertions(+), 16 deletions(-)

diff --git a/solus_sc/changelog.py b/solus_sc/changelog.py
index eec1018..53a2383 100755
--- a/solus_sc/changelog.py
+++ b/solus_sc/changelog.py
@@ -19,12 +19,12 @@ from . import PACKAGE_ICON_NORMAL
 from . import PACKAGE_ICON_SECURITY
 
 # Helpful for determing CVE matches.
-CVE_HIT = re.compile(r".*(CVE\-[0-9]+\-[0-9]+).*")
+CVE_HIT = re.compile(r"(CVE\-[0-9]+\-[0-9]+)")
 CVE_URI = "https://cve.mitre.org/cgi-bin/cvename.cgi?name={}"
 
 # All TNNNN hits are Maniphest Tasks
 BUG_HIT = re.compile(r"T(\d+)")
-BUG_URI = "https://dev.solus-project.com/{}"
+BUG_URI = "https://dev.solus-project.com"
 
 # I know, it's evil. From:
 # http://daringfireball.net/2010/07/improved_regex_for_matching_urls
@@ -65,26 +65,14 @@ class ScChangelogEntry(Gtk.EventBox):
             r = MARKUP_URI_HIT.sub(r'<a href="\2">\1</a>', r)
             r = MARKUP_CODE_HIT.sub(r'<tt>\1</tt>', r)
             r = MARKUP_BOLD_HIT.sub(r'<b>\1</b>', r)
+            r = CVE_HIT.sub(r'<a href="\1">\1</a>', r)
+            r = BUG_HIT.sub(r'<a href="{}/T\1">T\1</a>'.format(BUG_URI), r)
 
             # Check if this is a bullet point
             if (r.startswith("- ") or r.startswith("* ")) and len(r) > 2:
                 r = u' \u2022 ' + r[2:]
 
             for i in r.split(" "):
-                cve = CVE_HIT.match(i.upper())
-                if cve is not None:
-                    cve_id = cve.group(0)
-                    href = "<a href=\"{}\">{}</a>".format(
-                        CVE_URI.format(cve_id), cve_id)
-                    ret += href + i[len(cve_id):] + " "
-                    continue
-                bug = BUG_HIT.match(i.upper())
-                if bug is not None:
-                    bug_id = bug.group(0)
-                    href = "<a href=\"{}\">{}</a>".format(
-                        BUG_URI.format(bug_id), bug_id)
-                    ret += href + i[len(bug_id):] + " "
-                    continue
                 uri = GENERAL_URI.match(i)
                 if uri is not None:
                     uri_href = uri.group(0)
-- 
2.13.0

