From 8f93df5c91889c77998528ecf4c08ef8795e5ea5 Mon Sep 17 00:00:00 2001
From: Ikey Doherty <ikey@solus-project.com>
Date: Mon, 20 Jun 2016 00:07:35 +0100
Subject: [PATCH 3/3] Ensure we can handle obsolete/replace

Signed-off-by: Ikey Doherty <ikey@solus-project.com>
---
 solus_sc/basket.py       | 11 +++++++----
 solus_sc/updates_view.py | 19 +++++++++++++++++--
 2 files changed, 24 insertions(+), 6 deletions(-)

diff --git a/solus_sc/basket.py b/solus_sc/basket.py
index 4c59487..aa59720 100644
--- a/solus_sc/basket.py
+++ b/solus_sc/basket.py
@@ -181,7 +181,7 @@ class BasketView(Gtk.Revealer):
         self.update_ui()
 
     def update_package(self, old_package, new_package):
-        self.operations[old_package.name] = 'UPDATE'
+        self.operations[new_package.name] = 'UPDATE'
         self.update_ui()
 
     def _get_prog(self, step):
@@ -402,7 +402,8 @@ class BasketView(Gtk.Revealer):
             if packageset == installs:
                 (pg, pkgs) = plan_install_pkg_names(packageset)
                 if len(pkgs) > len(packageset):
-                    if self.show_dialog(pkgs):
+                    p = [x for x in pkgs if x not in packageset]
+                    if self.show_dialog(p):
                         installs = packageset = pkgs
                     else:
                         # print "Not installing"
@@ -410,7 +411,8 @@ class BasketView(Gtk.Revealer):
             elif packageset == removals:
                 (pk, pkgs) = plan_remove(packageset)
                 if len(pkgs) > len(packageset):
-                    if self.show_dialog(pkgs, remove=True):
+                    p = [x for x in pkgs if x not in packageset]
+                    if self.show_dialog(p, remove=True):
                         removals = packageset = pkgs
                     else:
                         # print "Not removing"
@@ -418,7 +420,8 @@ class BasketView(Gtk.Revealer):
             elif packageset == updates:
                 (pk, pkgs) = plan_upgrade(packageset)
                 if len(pkgs) > len(packageset):
-                    if self.show_dialog(pkgs, update=True):
+                    p = [x for x in pkgs if x not in packageset]
+                    if self.show_dialog(p, update=True):
                         updates = packageset = pkgs
                     else:
                         # print Not continuing
diff --git a/solus_sc/updates_view.py b/solus_sc/updates_view.py
index fd6681a..4bada96 100755
--- a/solus_sc/updates_view.py
+++ b/solus_sc/updates_view.py
@@ -298,7 +298,6 @@ class ScUpdatesView(Gtk.VBox):
         return False
 
     def load_updates(self):
-        print("I AM LOADING TEH UPDATES")
         self.basket.invalidate_all()
         GObject.idle_add(self.init_view)
 
@@ -524,7 +523,18 @@ class ScUpdatesView(Gtk.VBox):
         upgrades = pisi.api.list_upgradable()
         n_updates = len(upgrades)
 
+        obsol = pisi.api.list_obsoleted()
+        replc = pisi.api.list_replaces()
         for item in sorted(upgrades):
+
+            old_item = item
+            if item in obsol:
+                if item not in replc:
+                    # No valid replacement, skip it
+                    continue
+                # Chose the replacement
+                item = replc[item][0]
+
             new_pkg = self.packagedb.get_package(item)
             new_version = "%s-%s" % (str(new_pkg.version),
                                      str(new_pkg.release))
@@ -561,7 +571,12 @@ class ScUpdatesView(Gtk.VBox):
             pkg_name = GLib.markup_escape_text(pkg_name)
             summary = GLib.markup_escape_text(summary)
 
-            p_print = "%s - <small>%s</small>\n%s" % (pkg_name,
+            if old_item != item:
+                pref = "%s (replaces %s)" % (pkg_name, old_item)
+            else:
+                pref = "%s" % (pkg_name)
+
+            p_print = "%s - <small>%s</small>\n%s" % (pref,
                                                       new_version,
                                                       summary)
 
-- 
2.8.4

